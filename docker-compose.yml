version: '3.8'

services:
  datapipeline:
    build:
      context: ./src/datapipeline
      dockerfile: Dockerfile
    image: preprocess-data
    container_name: preprocess-data
    volumes:
      # Mount secrets directory (adjust path as needed)
      - ./secrets:/home/app/.config/gcloud:ro
      # Add any data directories you need here
      # - ./data:/app/data:rw
    environment:
      - GOOGLE_APPLICATION_CREDENTIALS=/home/app/.config/gcloud/application_default_credentials.json
      - PYTHONUNBUFFERED=1
    # Default command - runs preprocessing scripts sequentially
    command: ["-c", "source /home/app/.venv/bin/activate && python preprocess_clean.py && python preprocess_rag.py"]

  models:
    build:
      context: .
      dockerfile: ./src/models/Dockerfile
    image: ml-model
    container_name: ml-model
    volumes:
      # Mount secrets directory (adjust path as needed)
      - ./secrets:/home/app/.config/gcloud:ro
      # Add any data directories you need here
      # - ./data:/app/data:rw
    environment:
      - GOOGLE_APPLICATION_CREDENTIALS=/home/app/.config/gcloud/application_default_credentials.json
      - PYTHONUNBUFFERED=1
    # Default command - runs model RAG classification
    command: ["-c", "source /home/app/.venv/bin/activate && python model_rag.py --project_id 1097076476714 --index_endpoint_id 3044332193032699904 --deployed_index_id phishing_emails_deployed_1760372787396"]

